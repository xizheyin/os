# ðŸ˜­ ä¿æŠ¤æ¨¡å¼

### å˜åŒ–

80386å¼€å§‹ï¼ŒIntelå¤„ç†å™¨æ­¥å…¥32ä½CPUï¼›80386æœ‰32ä½åœ°å€çº¿ï¼Œå…¶å¯»å€ç©ºé—´ä¸º 2^32=4GB ï¼›ä¸ºä¿è¯å…¼å®¹ æ€§ï¼Œå®žæ¨¡å¼å¾—ä»¥ä¿ç•™ï¼ŒPCå¯åŠ¨æ—¶CPUå·¥ä½œåœ¨å®žæ¨¡å¼ï¼ˆBIOSè¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šå¼€å¯ä¿æŠ¤æ¨¡å¼ï¼‰ï¼Œå¹¶ç”±Bootloaderè¿…é€Ÿå®Œæˆä»Žå®žæ¨¡å¼å‘ä¿æŠ¤æ¨¡å¼çš„åˆ‡æ¢ã€‚

ä¸‹é¢æ˜¯ä¿æŠ¤æ¨¡å¼çš„ä¸€äº›ä¸åŒã€‚

1. ä¿æŠ¤æ¨¡å¼ä¸‹çš„å¯„å­˜å™¨
   * é€šç”¨å¯„å­˜å™¨(ä»Ž 16 ä½æ‰©å±•ä¸º 32 ä½): EAXï¼ŒEBXï¼ŒECXï¼Œ EDXï¼ŒESIï¼ŒEDIï¼ŒEBPï¼ŒESP
   * æ®µå¯„å­˜å™¨(ç»´æŒ 16 ä½): CSï¼ŒDSï¼ŒSSï¼ŒESï¼ŒFSï¼ŒGS
   * çŠ¶æ€å’ŒæŽ§åˆ¶å¯„å­˜å™¨(32/64 ä½): EFLAGSï¼ŒEIPï¼ŒCR0ï¼ŒCR1ï¼Œ CR2ï¼ŒCR3
   * ç³»ç»Ÿåœ°å€å¯„å­˜å™¨: GDTRï¼ŒIDTRï¼ŒTRï¼ŒLDTR
   * è°ƒè¯•ä¸Žæµ‹è¯•ç”¨å¯„å­˜å™¨: DR0ï¼ŒÂ· Â· Â· ï¼ŒDR7ï¼ŒTR0ï¼ŒÂ· Â· Â· ï¼ŒTR7
2. å¯»å€æ–¹å¼çš„å˜åŒ–
   * åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œåˆ†æ®µæœºåˆ¶æ˜¯åˆ©ç”¨ä¸€ä¸ªç§°ä½œæ®µé€‰æ‹©å­ï¼ˆ`Selector`ï¼‰çš„åç§»é‡åˆ°å…¨å±€æè¿°ç¬¦è¡¨ä¸­æ‰¾åˆ°éœ€è¦çš„æ®µæè¿°ç¬¦ï¼Œè€Œè¿™ä¸ªæ®µæè¿°ç¬¦ä¸­å°±å­˜æ”¾ç€çœŸæ­£çš„æ®µçš„ç‰©ç†é¦–åœ°å€ï¼Œè¯¥ç‰©ç†é¦–åœ°å€åŠ ä¸Šåç§»é‡å³å¯å¾—åˆ°æœ€åŽçš„ç‰©ç†åœ°å€ã€‚
   * ä¸€èˆ¬ä¿æŠ¤æ¨¡å¼çš„å¯»å€å¯ç”¨ 0xMMMM:0xNNNNNNNN è¡¨ç¤ºï¼Œå…¶ä¸­ 0xMMMM è¡¨ç¤ºæ®µé€‰æ‹©å­çš„å–å€¼ï¼Œ16 ä½(å…¶ä¸­é«˜ 13 ä½è¡¨ç¤ºå…¶å¯¹åº”çš„æ®µæè¿°ç¬¦åœ¨å…¨å±€æè¿°ç¬¦è¡¨ä¸­çš„ç´¢å¼•ï¼Œä½Ž 3 ä½è¡¨ç¤ºæƒé™ ç­‰ä¿¡æ¯)ï¼Œ0xNNNNNNNN è¡¨ç¤ºåç§»é‡çš„å–å€¼ï¼Œ32 ä½ã€‚
   * æ®µé€‰æ‹©å­ä¸º CSï¼ŒDSï¼ŒSSï¼ŒESï¼ŒFSï¼ŒGS è¿™äº›æ®µå¯„å­˜å™¨ã€‚

### å¯»å€è¿‡ç¨‹

åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œå¯»å€æ–¹å¼ä¼šäº§ç”Ÿå˜åŒ–ã€‚ç®€å•æ¥è¯´ï¼Œç¨‹åºç»™å‡ºçš„32ä½åœ°å€ä¸å†ç›´æŽ¥è§£é‡Šä¸ºç‰©ç†åœ°å€ï¼Œè€Œæ˜¯ç›¸å¯¹äºŽæŸä¸€ä¸ªæ®µçš„åç§»é‡ï¼ˆ`offset`ï¼‰ã€‚çœŸæ­£çš„ç‰©ç†åœ°å€ç”±ä¸‹å¼ç»™å‡ºï¼š

```
 physical address = base address + offset
```

å…¶ä¸­çš„`base address`æ˜¯ä¸€ä¸ª32ä½çš„åœ°å€ï¼Œå¯¹åº”æŸä¸ªæ®µçš„åŸºåœ°å€ï¼›è€Œ`offset`åˆ™æ˜¯ç¨‹åºç»™å‡ºçš„32ä½æ®µå†…åç§»é‡ã€‚åŸºåœ°å€å­˜å‚¨åœ¨**æ®µæè¿°ç¬¦**é‡Œé¢ï¼Œè€Œ**æ®µæè¿°ç¬¦éœ€è¦é€šè¿‡Selectoræ¥å¯»æ‰¾**ï¼

å½“å¼€å¯ä¿æŠ¤æ¨¡å¼åŽï¼ŒQEMUä¸­è¿è¡Œçš„ç¨‹åºè®¿åœ¨é—®å†…å­˜æ—¶ç»™å‡ºçš„å°±ä¸ç®€å•æ˜¯32ä½çš„ç‰©ç†åœ°å€äº†ï¼Œè€Œæ˜¯ç”±ä¸€ä¸ª16ä½çš„æ®µé€‰æ‹©ç¬¦åŠ ä¸Š32ä½çš„æ®µå†…åç§»é‡ï¼ˆæœ‰æ•ˆåœ°å€ï¼‰æ‰€æž„æˆçš„48ä½çš„é€»è¾‘åœ°å€ï¼

```
           15              0    31                                   0
  LOGICAL +----------------+   +-------------------------------------+
  ADDRESS |    SELECTOR    |   |        OFFSET (EFFECTIVE ADDR)      |
          +---+---------+--+   +-------------------+-----------------+

48ä½é€»è¾‘åœ°å€ç»“æž„
```

### GDT

å…¨å±€æè¿°ç¬¦è¡¨ï¼ˆ`Global Descriptor Table`ï¼‰ï¼Œå³`GDT`ï¼Œ`GDT`ç”±ä¸€ä¸ªä¸ªè¢«ç§°ä¸º**æ®µæè¿°ç¬¦**çš„è¡¨é¡¹ç»„æˆï¼Œè¡¨é¡¹ä¸­å®šä¹‰äº†æ®µçš„èµ·å§‹32ä½ç‰©ç†åœ°å€ï¼Œæ®µçš„ç•Œé™ï¼Œå±žæ€§ç­‰å†…å®¹ï¼›æ®µæè¿°ç¬¦çš„ç»“æž„å¦‚ä¸‹å›¾æ‰€ç¤º

```
DESCRIPTORS USED FOR APPLICATIONS CODE AND DATA SEGMENTS

  31                23                15                7               0
 +-----------------+-+-+-+-+---------+-+-----+-+-----+-+-----------------+
 |                 | | | |A|         | |     | |     | |                 |
 |   BASE 31..24   |G|X|O|V| LIMIT   |P| DPL |1| TYPE|A|  BASE 23..16    | 4
 |                 | | | |L| 19..16  | |     | |     | |                 |
 |-----------------+-+-+-+-+---------+-+-----+-+-----+-+-----------------|
 |                                   |                                   |
 |        SEGMENT BASE 15..0         |       SEGMENT LIMIT 15..0         | 0
 |                                   |                                   |
 +-----------------------------------+-----------------------------------+

           A      - ACCESSED
           AVL    - AVAILABLE FOR USE BY SYSTEMS PROGRAMMERS
           DPL    - DESCRIPTOR PRIVILEGE LEVEL
           G      - GRANULARITY
           P      - SEGMENT PRESENT
```

ä½ å¯ä»¥æŠŠæ®µæè¿°ç¬¦å½“åšä¸€ä¸ªç»“æž„ä½“ï¼Œè¿™æ ·ï¼Œæ®µè¡¨å°±ç›¸å½“äºŽä¸€ä¸ª**ç»“æž„æ•°ç»„ã€‚**

è¿™é‡Œæ˜¯æ®µæè¿°ç¬¦æ¯ä¸ªéƒ¨åˆ†çš„å«ä¹‰ï¼š

* æ¯ä¸ªæ®µæè¿°ç¬¦ä¸º 8 ä¸ªå­—èŠ‚ï¼Œå…± 64 ä½
* æ®µåŸºå€ä¸ºç¬¬ 2ï¼Œ3ï¼Œ4ï¼Œ7 å­—èŠ‚ï¼Œå…± 32 ä½
* æ®µé™â»“ä¸ºç¬¬ 0ï¼Œ1 å­—èŠ‚åŠç¬¬ 6 å­—èŠ‚çš„ä½Ž 4 ä½ï¼Œå…± 20 ä½ï¼Œè¡¨ç¤ºè¯¥æ®µçš„æœ€å¤§â»“åº¦
* Gä»£è¡¨ç²’åº¦ï¼Œè¯´æ˜Žæ®µé™é•¿çš„å•ä½æ˜¯ä»€ä¹ˆï¼ˆ4KBæˆ–è€…1Bï¼‰ã€‚å½“å±žæ€§ G ä¸º 0 æ—¶ï¼Œ20 ä½æ®µé™â»“ä¸ºå®žé™…æ®µçš„æœ€å¤§â»“åº¦(æœ€å¤§ä¸º 1MB)ï¼›å½“å±žæ€§ G ä¸º 1 æ—¶ï¼Œè¯¥ 20 ä½æ®µé™â»“å·¦ç§» 12 ä½åŽåŠ ä¸Š 0xFFF å³ä¸ºå®žé™…æ®µçš„æœ€å¤§â»“åº¦(æœ€å¤§ä¸º 4GB) ã€‚
* D/B: å¯¹äºŽä¸åŒç±»åž‹æ®µå«ä¹‰ä¸åŒ
  * åœ¨å¯æ‰§è¡Œä»£ç æ®µï¼Œè¯¥ä½å«åš D ä½ï¼ŒD ä¸º 1 æ—¶ï¼Œä½¿ç”¨ 32 ä½åœ°å€å’Œ 32/8 ä½æ“ä½œæ•°ï¼ŒD ä¸º 0 ä½¿ç”¨ 16 ä½åœ°å€å’Œ 16/8 ä½æ“ä½œæ•°
  * åœ¨å‘ä¸‹æ‰©å±•çš„æ•°æ®æ®µä¸­ï¼Œè¯¥ä½å«åš B ä½ï¼ŒB ä¸º 1 æ®µçš„ä¸Šç•Œä¸º 4GBï¼ŒB ä¸º 0 æ®µçš„ä¸Šç•Œä¸º 64KB
  * åœ¨æè¿°å †æ ˆæ®µçš„æè¿°ç¬¦ä¸­ï¼Œè¯¥ä½å«åš B ä½ï¼ŒB ä¸º 1 ä½¿ç”¨ 32 ä½ æ“ä½œæ•°ï¼Œå †æ ˆæŒ‡é’ˆç”¨ ESPï¼ŒB ä¸º 0 ä½¿ç”¨ 16 ä½æ“ä½œæ•°ï¼Œå †æ ˆæŒ‡é’ˆç”¨ SP
* AVLï¼šAvailable and Reserved Bitï¼Œé€šå¸¸è®¾ä¸º 0
* Pï¼šå­˜åœ¨ä½ï¼ŒP ä¸º 1 è¡¨ç¤ºæ®µåœ¨å†…å­˜ä¸­
* DPLï¼šæè¿°ç¬¦ç‰¹æƒçº§ï¼Œå–å€¼ 0-3 å…± 4 çº§;0 ç‰¹æƒçº§æœ€é«˜ï¼Œ3 ç‰¹æƒçº§æœ€ä½Žï¼Œè¡¨ç¤ºè®¿é—®è¯¥æ®µæ—¶ CPU æ‰€å¤„äºŽçš„æœ€ä½Žç‰¹æƒçº§ï¼ŒåŽç»­å®žéªŒä¼šè¯¦ç»†è®¨è®º
* Sï¼šæè¿°ç¬¦ç±»åž‹æ ‡å¿—ï¼ŒS ä¸º 1 è¡¨ç¤ºä»£ç æ®µæˆ–æ•°æ®æ®µï¼ŒS ä¸º 0 è¡¨ç¤ºç³»ç»Ÿæ®µ(TSSï¼ŒLDT)å’Œé—¨æè¿°ç¬¦
* TYPEï¼šå½“ S ä¸º 1ï¼ŒTYPE è¡¨ç¤ºçš„ä»£ç æ®µï¼Œæ•°æ®æ®µçš„å„ç§å±žæ€§å¦‚ä¸‹è¡¨æ‰€ç¤º

![TYPEä½](../../../.gitbook/assets/image7.png)

### æ®µé€‰æ‹©å­å¦‚ä½•æŸ¥æ‰¾æ®µæè¿°ç¬¦

ä¸ºè¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œéœ€è¦åœ¨å†…å­˜ä¸­å¼€è¾Ÿä¸€å—ç©ºé—´å­˜æ”¾GDTè¡¨ï¼›80386æä¾›äº†ä¸€ä¸ª**å¯„å­˜å™¨ `GDTR` ç”¨æ¥å­˜æ”¾`GDT` çš„32ä½ç‰©ç†åŸºåœ°å€ä»¥åŠè¡¨é•¿ç•Œé™**ï¼›åœ¨å°†GDTè®¾å®šåœ¨å†…å­˜çš„æŸä¸ªä½ç½®åŽï¼Œå¯ä»¥**é€šè¿‡ LDGT æŒ‡ä»¤å°†GDTçš„å…¥ å£åœ°å€è£…å…¥æ­¤å¯„å­˜å™¨ã€‚**

```
          GDT REGISTER
                  15            0
                 +---------------+
                 |   GDT LIMIT   |
+----------------+---------------|
|            GDT BASE  	         |
+--------------------------------+
 31                             0
```

ç”± GDTR è®¿é—®GDTæ˜¯ç”±**æ®µé€‰æ‹©å­ï¼ˆç†è§£æˆæ®µé€‰æ‹©å­é‡ŒåŒ…å«æ•°ç»„ä¸‹æ ‡ï¼‰**æ¥å®Œæˆçš„ï¼›ä¸ºè®¿é—®ä¸€ä¸ªæ®µï¼Œéœ€å°†æ®µé€‰æ‹©å­å­˜å‚¨å…¥**æ®µå¯„å­˜å™¨**ï¼Œæ¯”å¦‚æ•°æ®æ®µé€‰æ‹©å­å­˜å‚¨å…¥ `DS` ï¼Œä»£ç æ®µé€‰æ‹©å­å­˜å‚¨å…¥ `CS` ï¼›å…¶æ•°æ®ç»“æž„å¦‚ä¸‹

```
 15                      3   1 0
+-------------------------+-+---+
|                         |T|   |
|          INDEX          | |RPL|
|                         |I|   |
+-------------------------+-+---+
TI - TABLE INDICATOR, 0 = GDT, 1 = LDT
RPL - REQUESTOR'S PRIVILEGE LEVEL
```

`TI`ä½è¡¨ç¤ºè¯¥æ®µé€‰æ‹©å­ä¸ºå…¨å±€æ®µè¿˜æ˜¯å±€éƒ¨æ®µï¼Œ`RPL`è¡¨ç¤ºè¯¥æ®µé€‰æ‹©å­çš„ç‰¹æƒç­‰çº§ï¼Œ13ä½`Index`è¡¨ç¤ºæè¿°ç¬¦è¡¨ä¸­çš„ç¼–å·ï¼ˆä¸‹æ ‡ï¼‰



ä¸‹å›¾æ˜¯é€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ï¼š

```
         15              0    31                                  0
LOGICAL +----------------+   +-------------------------------------+
ADDRESS |    SELECTOR    |   |               OFFSET                |
        +---+---------+--+   +-------------------+-----------------+
     +------+         !                          |
     | DESCRIPTOR TABLE                          |
     |  +------------+                           |
     |  |            |                           |
     |  |            |                           |
     |  |            |                           |
     |  |            |                           |
     |  |------------|                           |
     |  |   SEGMENT  | BASE          +---+       |
     +->| DESCRIPTOR |-------------->| + |<------+
        |------------| ADDRESS       +-+-+
        |            |                 |
        +------------+                 |
                                       !
             LINEAR +------------+-----------+--------------+
            ADDRESS |     DIR    |    PAGE   |     OFFSET   |
                    +------------+-----------+--------------+
```

### æ€»ç»“åœ°å€è½¬æ¢è¿‡ç¨‹

ç»“åˆè™šæ‹Ÿåœ°å€ã€æ®µé€‰æ‹©ç¬¦å’Œæ®µè¡¨çš„ç›¸å…³æ¦‚å¿µï¼Œåœ¨åˆ†æ®µæœºåˆ¶ä¸­ï¼Œå°†è™šæ‹Ÿåœ°å€è½¬æ¢æˆçº¿æ€§åœ°å€ï¼ˆæ­¤æ—¶å³ä¸ºç‰©ç†åœ°å€ï¼‰çš„è¿‡ç¨‹å¯æè¿°å¦‚ä¸‹ï¼š

1. æ ¹æ®æ®µé€‰æ‹©å­ä¸­çš„`TI`ä½é€‰æ‹©GDTæˆ–LDTï¼›
2. æ ¹æ®æ®µé€‰æ‹©å­ä¸­çš„`index`éƒ¨åˆ†åˆ°GDTä¸­æ‰¾åˆ°å¯¹åº”ä½ç½®ä¸Šçš„æ®µæè¿°ç¬¦ï¼›
3. è¯»å–æ®µæè¿°ç¬¦ä¸­çš„`base`éƒ¨åˆ†ï¼Œä½œä¸º32ä½æ®µåŸºå€ï¼ŒåŠ ä¸Š32ä½æ®µå†…åç§»é‡èŽ·å–æœ€ç»ˆçš„ç‰©ç†åœ°å€ã€‚



### Reference

æœ¬èŠ‚éƒ¨åˆ†å†…å®¹æ‘˜è‡ªã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹PA-3-2çš„æ‰‹å†Œã€‚
